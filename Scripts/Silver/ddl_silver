/*
================================================================
SCRIPT PURPOSE:-
  THIS SCRIPT IS RESPONSIBLE FOR BOTH THE CREATION (DDL) AND INSERTION OF THE 
  TRANSFORMED DATA INTO THE SILVER LAYER. ALSO IN THIS SAME SCIPT WE HAVE CREATED A STORED PROCEDURE
  SILVER.LOAD_SILVER (RESPONSIBLE FOR THE INSERTING OF THE TRANSFORMED DATA INTO THE TABLES OF THE 
  SILVER LAYER CREATED BY THE DDL STATEMENTS)

DEVELOPED BY :- ANEES AHMAD
==================================================================
*/



use datawarehouse
--Building Silver layer
--1) this is for CRM tables
if OBJECT_ID('Silver.crm_cust_info','U') IS NOT NULL
    DROP TABLE Silver.crm_cust_info
Create TABLE Silver.crm_cust_info(
    cst_id int,
    cst_key NVARCHAR(50),
    cst_first_name NVARCHAR(50),
    cst_last_name NVARCHAR(50),
    cst_material_status NVARCHAR(50),
    cst_gndr NVARCHAR(50),
    cst_create_date date,
    dwh_create_date DATETIME2 default GETDATE()   
)

if OBJECT_ID('Silver.crm_prd_info','U') IS NOT NULL
    DROP TABLE Silver.crm_prd_info
create TABLE Silver.crm_prd_info(
    prd_id int,
	cat_id nvarchar(50),
    prd_key NVARCHAR(50),
    prd_nm NVARCHAR(100),
    prd_cost INT,
    prd_line NVARCHAR(50),
    prd_start_dt DATE,
    prd_end_dt DATE,
    dwh_create_date DATETIME2 default GETDATE()
)

if OBJECT_ID('Silver.crm_sales_details','U') IS NOT NULL
    DROP TABLE Silver.crm_sales_details
CREATE TABLE Silver.crm_sales_details(
    sls_ord_num VARCHAR(50),
    sls_prd_key NVARCHAR(50),
    sls_cust_id INT,
    sls_order_dt date,
    sls_ship_dt date,
    sls_due_dt date,
    sls_sales INT,
    sls_quantity INT,
    sls_price INT,
    dwh_create_date DATETIME2 default GETDATE()
)
--2)this is for ERP tables 

if OBJECT_ID('Silver.erp_loc_A101','U') IS NOT NULL
    DROP TABLE Silver.erp_loc_A101
create TABLE Silver.erp_loc_A101(
    CID NVARCHAR(50)    ,
    CNTRY NVARCHAR(50),
    dwh_create_date DATETIME2 default GETDATE()
)

if OBJECT_ID('Silver.erp_cust_AZ12','U') IS NOT NULL
    DROP TABLE Silver.erp_cust_AZ12
CREATE TABLE Silver.erp_cust_AZ12(
        CID NVARCHAR(50),
        BDATE DATE,
        GEN NVARCHAR(50),
        dwh_create_date DATETIME2 default GETDATE()
)

if OBJECT_ID('Silver.erp_px_cat_g1v2','U') IS NOT NULL
    DROP TABLE Silver.erp_px_cat_g1v2
CREATE TABLE Silver.erp_px_cat_g1v2(
    ID NVARCHAR(50),
    CAT NVARCHAR(50),
    SUBCAT NVARCHAR(50),
    MAINTENANCE NVARCHAR(50),
    dwh_create_date DATETIME2 default GETDATE()
)

--creating stored Procedure 
create or alter Procedure silver.load_silver AS
 BEGIN
   DECLARE @Start_time Datetime ,@end_time datetime, @batch_start_time datetime,@batch_end_time datetime;
   BEGIN TRY
   set @batch_start_time=GETDATE();
   PRINT'*********************************************'
   PRINT'LOADING THE SILVER LAYER! --> NEZGOOO'
   PRINT'*********************************************'
   PRINT'---------------------------------------------'
   PRINT'Loading CRM Tables'
   PRINT'---------------------------------------------'

	--inserting the transfomed data into tables
	--1) this is for crm_cust_info data inporting into silver (Transformed data)
	set @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.crm_cust_info'
	truncate table Silver.crm_cust_info
	PRINT'>> Inserting Data into: Silver.crm_cust_info'
	insert into Silver.crm_cust_info(
			cst_id,
			cst_key,
			cst_first_name,
			cst_last_name,
			cst_gndr,
			cst_material_status,
			cst_create_date
		)
		select 
			cst_id,
			cst_key,
			Trim(cst_first_name) as cst_first_name,
			Trim(cst_last_name) as cst_last_name,
			CASE UPPER(TRIM(cst_gndr))
				When 'F' then 'Female'
				When 'M' then 'Male'
				ELSE 'N/A' --Normalization of Gender to readable formate
			END cst_gndt,
			CASE UPPER(TRIM(cst_material_status))
				When 'M' then 'Married'
				When 'S' then 'Single'
				ELSE 'N/A'--Normalization of martial status to readable formate
			END cst_material_status,
			cst_create_date
			from (
				select 
				*,
				ROW_NUMBER() over(Partition by cst_id order by cst_create_date desc) as flag_last
				from Bronze.crm_cust_info
				where cst_id is not null 
			)t 
			where flag_last=1 --duplicates removed (Select most recent record per customer)
		set @end_time=GETDATE()
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@start_time,@end_time) as Nvarchar)+' Seconds'
		PRINT'---------------------------------------------'
	
	--2 this is for crm_prd_info data inporting into silver (Transformed data)
	SET @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.crm_prd_info'
	truncate table Silver.crm_prd_info
	PRINT'>> Inserting Data into: Silver.crm_prd_info'
	insert into Silver.crm_prd_info(
			prd_id,
			cat_id,
			prd_key,
			prd_nm,
			prd_cost,
			prd_line,
			prd_start_dt,
			prd_end_dt
			)
		  SELECT [prd_id]
			  ,Replace(SUBSTRING(prd_key,1,5),'-','_') as cat_id --extract category id
			  ,SUBSTRING(prd_key,7,LEN(prd_key)) as prd_key--extract Product key
			  ,[prd_nm]
			  ,isnull([prd_cost],0) as prd_cost,
			CASE UPPER(TRIM(prd_line))
				WHEN 'M' THEN 'Mountain'
				WHEN 'R' THEN 'Road'
				WHEN 'S' THEN 'Other Sales'
				WHEN 'T' THEN 'Touring'
				ELSE 'N/A'
			END AS prd_line, --Map product line codes to descriptive values (Improved catdinality)
			   CAST([prd_start_dt] AS DATE) AS prd_start_dt ,
   			   CAST(lead(prd_start_dt) 
					   over(Partition by prd_key order by prd_start_dt)-1 as Date) as prd_end_dt--calculate end date as one day before the next start date
		  FROM [DataWarehouse].[Bronze].[crm_prd_info]
		set @end_time=GETDATE()
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@start_time,@end_time) as Nvarchar)+' Seconds'
		PRINT'---------------------------------------------'
	--3) this is for crm_prd_sales data inporting into silver (Transformed data)
	SET @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.crm_sales_details'
	truncate table Silver.crm_sales_details
	PRINT'>> Inserting Data into: Silver.crm_sales_details'
	insert into Silver.crm_sales_details(
		   [sls_ord_num]
		  ,[sls_prd_key]
		  ,[sls_cust_id]
		  ,[sls_order_dt]
		  ,[sls_ship_dt]
		  ,[sls_due_dt]
		  ,[sls_sales]
		  ,[sls_quantity]
		  ,[sls_price]
	)
		SELECT [sls_ord_num]
			  ,[sls_prd_key]
			  ,[sls_cust_id],
		  CASE WHEN sls_order_dt=0 or LEN(sls_order_dt)<>8 
			   THEN NULL
			   ELSE CAST(CAST(sls_order_dt as varchar)as date)
		  END as sls_order_dt,
		  CASE WHEN sls_ship_dt=0 or LEN(sls_ship_dt)<>8 
			   THEN NULL
			   ELSE CAST(CAST(sls_ship_dt as varchar)as date)
		  END as sls_ship_dt,
		  CASE WHEN sls_due_dt=0 or LEN(sls_due_dt)<>8 
			   THEN NULL
			   ELSE CAST(CAST(sls_due_dt as varchar)as date)
		  END as sls_due_dt,
		  CASE 
			WHEN sls_sales is null or sls_sales <=0 or sls_sales<>sls_quantity*ABS(sls_price)
			THEN sls_quantity*ABS(sls_price)
			ELSE sls_sales 
		  END AS sls_sales,
			   [sls_quantity],
		  CASE 
			WHEN sls_price is null or sls_price <=0 
			THEN sls_sales/NULLIF(sls_quantity,0)
			ELSE sls_price
		  END AS sls_price  
		  FROM [DataWarehouse].[Bronze].[crm_sales_details]
	 	set @end_time=GETDATE()
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@start_time,@end_time) as Nvarchar)+' Seconds'
		PRINT'---------------------------------------------'

	--4) this is for erp_cust_azi12 data inporting into silver (Transformed data)
    PRINT'---------------------------------------------'
    PRINT'Loading ERP Tables'
    PRINT'---------------------------------------------'
	SET @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.erp_cust_AZ12'
	truncate table Silver.erp_cust_AZ12
	PRINT'>> Inserting Data into: Silver.erp_cust_AZ12'
	insert into Silver.erp_cust_AZ12(
		   [CID]
		  ,[BDATE]
		  ,[GEN])
		select 
			CASE
				WHEN CID LIKE 'NAS%' 
				THEN SUBSTRING(CID,4,LEN(CID))
				ELSE CID 
			END AS cid,
			CASE
				WHEN BDATE >GETDATE()
				THEN null
				ELSE BDATE
			END AS bdate,
			CASE 
				WHEN UPPER(TRIM(GEN)) IN ('M','MALE') THEN 'Male'
				WHEN UPPER(TRIM(GEN)) IN ('F','FEMALE') THEN 'Female'
				ELSE 'N/A'
			END AS gen
		from Bronze.erp_cust_AZ12
	 	set @end_time=GETDATE()
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@start_time,@end_time) as Nvarchar)+' Seconds'
		PRINT'---------------------------------------------'
	--5) this is for erp_loc_a101 data inporting into silver (Transformed data)
	SET @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.erp_loc_A101'
	truncate table Silver.erp_loc_A101
	PRINT'>> Inserting Data into: Silver.erp_loc_A101'
	insert into Silver.erp_loc_A101(
			[CID],
			[CNTRY])
		select 
		Replace(cid,'-','') as cid,
		CASE
			WHEN TRIM(CNTRY)='DE'THEN 'Germany'
			WHEN TRIM(CNTRY) in('US','USA') THEN 'United States'
			WHEN TRIM(CNTRY)='' or CNTRY is null then 'N/A'
			ELSE TRIM(CNTRY)
		END AS cntry --Managed the cardinality and normalize the data by handling missing values
		from Bronze.erp_loc_A101
		set @end_time=GETDATE()
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@start_time,@end_time) as Nvarchar)+' Seconds'
		PRINT'---------------------------------------------'
	--6) this is for erp_px_cat_g1v2 data inporting into silver (Transformed data)
	SET @Start_time=GETDATE()
	PRINT'>> Truncating Table : Silver.erp_px_cat_g1v2'
	truncate table Silver.erp_px_cat_g1v2
	PRINT'>> Inserting Data into: Silver.erp_px_cat_g1v2'
	insert into Silver.erp_px_cat_g1v2(
		   [ID]
		  ,[CAT]
		  ,[SUBCAT]
		  ,[MAINTENANCE])
		  select 
			* 
			from Bronze.erp_px_cat_g1v2
		set @batch_end_time=GETDATE()
        PRINT'*********************************************'
		PRINT'SILVER LAYER LOADED SUCCESSFULLY'
		PRINT'>> Load Duration :'+ CAST(DATEDIFF(SECOND,@batch_start_time,@batch_end_time) as Nvarchar)+' Seconds'
		PRINT'*********************************************'
	END TRY
	BEGIN CATCH
		PRINT'=============================================='
		PRINT'ERROR OCCURED DURING LOADING OF SILVER LAYER'
		PRINT'ERROR MESSAGE '+ ERROR_MESSAGE()
		PRINT'ERROR MESSAGE '+ CAST(ERROR_NUMBER() AS NVARCHAR)
		PRINT'ERROR MESSAGE '+ CAST(ERROR_STATE() AS NVARCHAR)
	END CATCH
 END

 --CHECKING THE STORED PROCEDURE 
 EXEC SILVER.load_silver
	
