/*
=====================================================================================
SCRIPT PURPOSE:-
  THE PRIMARY PURPOSE OF THIS SCRIPT IS TO SHOW ALL THE TRANSFORMATION, MANIPULATION
  AND THEN DATA VALIDATION TESTS THAT I HAVE DONE ON MY DATA IN THE SILVER LAYER 
  MAJORLY I TRANSFORMED THE TABLES OF THE BRONZE LAYER AND THEN INSERT THAT 
  TRANSFORMED DATA INTO THE SILVER LAYER TO BE USED 
  SO THIS IS KIND OF TESTING AND ROUGH QUERIES 
  PRIMARY PURPOSE :- TRANSFORMATION AND DATA VALIDATION TESTING 
  DEVELOPED BY :- ANEES AHMAD
  */

--checking for the quality isssues in the bronze layer
select 
	cst_id,
	COUNT(*) as occurance
	from Silver.crm_cust_info
	group by cst_id
	having COUNT(*)>1 or cst_id is null

select 
	*
	from [Bronze].[crm_cust_info]
	where cst_id=29466

--to remove the duplicates we will use the rank on behalf of the date in which we are going to take the lastest date record as correct one
select * from(
	select 
		*,
		ROW_NUMBER()over(Partition by cst_id order by cst_create_date desc) as flag_last
		from [Bronze].[crm_cust_info])t 
		where flag_last<>1
	
--checking for the unwanted space in the string fields
select 
	cst_last_name
	from Silver.crm_cust_info
	where cst_last_name<>TRIM(cst_last_name)


select 
	cst_id,
	cst_key,
	Trim(cst_first_name) as cst_first_name,
	Trim(cst_last_name) as cst_last_name,
	CASE
		When UPPER(TRIM(cst_gndr))='F' then 'Female'
		When UPPER(TRIM(cst_gndr))='M' then 'Male'
		ELSE 'N/A'
	END cst_gndt,
		CASE
		When UPPER(TRIM(cst_material_status))='M' then 'Married'
		When UPPER(TRIM(cst_material_status))='S' then 'Single'
		ELSE 'N/A'
	END cst_material_status,
	cst_create_date
	from (
		select 
		*,
		ROW_NUMBER() over(Partition by cst_id order by cst_create_date desc) as flag_last
		from Bronze.crm_cust_info
		where cst_id is not null 
	)t where flag_last=1

--data standardization & consistancy
select distinct cst_gndr
from silver.crm_cust_info

--this is the 2nd table prd_info
select * from Bronze.crm_prd_info

--checking for the nulls or duplicates in the primary key
select
	prd_id,
	count(*) 
	from Bronze.crm_prd_info
	group by prd_id
	having count(*)>1 or prd_id is null

SELECT [prd_id]
      ,[prd_key]
      ,Replace(SUBSTRING(prd_key,1,5),'-','_') as cat_id
	  ,SUBSTRING(prd_key,7,LEN(prd_key)) as prd_key
	  ,[prd_nm]
      ,[prd_cost]
      ,[prd_line]
      ,[prd_start_dt]
      ,[prd_end_dt]
  FROM [DataWarehouse].[Bronze].[crm_prd_info]
  --where Replace(SUBSTRING(prd_key,1,5),'-','_') not in
  --(select distinct ID from Bronze.erp_px_cat_g1v2)
   where SUBSTRING(prd_key,7,LEN(prd_key))  not in
  (select sls_prd_key from Bronze.crm_sales_details)

--checking the prd_nm for unwanted spaces
select * from Bronze.crm_prd_info
where prd_nm<>TRIM(prd_nm)

--checking for nulls or negative numbers in prd_cost
select prd_cost from Bronze.crm_prd_info
where prd_cost<0 or prd_cost is null


SELECT [prd_id]
      ,[prd_key]
      ,Replace(SUBSTRING(prd_key,1,5),'-','_') as cat_id--extract cat_id
	  ,SUBSTRING(prd_key,7,LEN(prd_key)) as prd_key  --extract Product key
	  ,[prd_nm]
      ,isnull([prd_cost],0) as prd_cost,
	  CASE UPPER(TRIM(prd_line))
		WHEN 'M' THEN 'Mountain'
		WHEN 'R' THEN 'Road'
		WHEN 'S' THEN 'Other Sales'
		WHEN 'T' THEN 'Touring'
	    ELSE 'N/A'
	  END AS prd_line --Map product line codes to descriptive values (Improved catdinality)
      ,[prd_start_dt],
   	  lead(prd_start_dt) over(Partition by prd_key order by prd_start_dt)-1 as prd_end_dt_test
  FROM [DataWarehouse].[Bronze].[crm_prd_info]

  select distinct(prd_line) from Bronze.crm_prd_info

  --data qulity check for the silver layer 
select
	prd_id,
	count(*) 
	from Silver.crm_prd_info
	group by prd_id
	having count(*)>1 or prd_id is null

select * from Silver.crm_prd_info
where prd_nm<>TRIM(prd_nm)

select * from Silver.crm_prd_info
where prd_nm<>TRIM(prd_nm)
--checking for the invalid date orders
select *
	from Silver.crm_prd_info
--*************************************
--this is transformation for sales products 
SELECT [sls_ord_num]
      ,[sls_prd_key]
      ,[sls_cust_id],
  CASE WHEN sls_order_dt=0 or LEN(sls_order_dt)<>8 
	   THEN NULL
	   ELSE CAST(CAST(sls_order_dt as varchar)as date)
  END as sls_order_dt,
  CASE WHEN sls_ship_dt=0 or LEN(sls_ship_dt)<>8 
	   THEN NULL
	   ELSE CAST(CAST(sls_ship_dt as varchar)as date)
  END as sls_ship_dt,
  CASE WHEN sls_due_dt=0 or LEN(sls_due_dt)<>8 
	   THEN NULL
	   ELSE CAST(CAST(sls_due_dt as varchar)as date)
  END as sls_due_dt,
  CASE 
	WHEN sls_sales is null or sls_sales <=0 or sls_sales<>sls_quantity*ABS(sls_price)
	THEN sls_quantity*ABS(sls_price)
	ELSE sls_sales 
  END AS sls_sales,
       [sls_quantity],
  CASE 
	WHEN sls_price is null or sls_price <=0 
	THEN sls_sales/NULLIF(sls_quantity,0)
	ELSE sls_price
  END AS sls_price  
  FROM [DataWarehouse].[Bronze].[crm_sales_details]

  --checking for the invalid dates
  select 
	Nullif(sls_order_dt,0) as sls_order_dt
	from Bronze.crm_sales_details
  where sls_order_dt<=0 
  or LEN(sls_order_dt)<>8 
  or sls_order_dt>20500101
  or sls_order_dt>19000101

  select * from Bronze.crm_sales_details
  where sls_order_dt>sls_ship_dt or sls_order_dt>sls_due_dt

--check data consistency b/w sales ,quantity & price 
--sales = quan* price
--value must not be null , zero or negative 
select distinct
	sls_sales AS Old_sls_sales ,
	sls_quantity,
	sls_price as Old_sls_price ,
  CASE 
	WHEN sls_sales is null or sls_sales <=0 or sls_sales<>sls_quantity*ABS(sls_price)
	THEN sls_quantity*ABS(sls_price)
	ELSE sls_sales 
  END AS sls_sales,
  CASE 
	WHEN sls_price is null or sls_price <=0 
	THEN sls_sales/NULLIF(sls_quantity,0)
	ELSE sls_price
  END AS sls_price
from Bronze.crm_sales_details
where sls_sales<>sls_quantity*sls_price
	or sls_sales is null or sls_quantity is null or sls_price is null
	or sls_sales <=0 or sls_quantity <=0 or sls_price <=0
order by sls_sales,sls_quantity,sls_price
--**************************************************
--doing the transformation for erp_cust_az12
select 
	cid,
	CASE
		WHEN CID LIKE 'NAS%' 
		THEN SUBSTRING(CID,4,LEN(CID))
		ELSE CID 
	END AS cid,
	CASE
		WHEN BDATE >GETDATE()
		THEN null
		ELSE BDATE
	END AS bdate,
	GEN,
	CASE 
		WHEN UPPER(TRIM(GEN)) IN ('M','MALE') THEN 'Male'
		WHEN UPPER(TRIM(GEN)) IN ('F','FEMALE') THEN 'Female'
		ELSE 'N/A'
	END AS gen
	from Bronze.erp_cust_AZ12

--working with the bdate column
select distinct
	bdate
	from Bronze.erp_cust_AZ12
	where BDATE<'1924-01-01' or BDATE>GETDATE()
--gender 
select distinct(gen) from Bronze.erp_cust_AZ12
--*********************************************
--this is for erp_loc_a101 transformation
select 
	Replace(cid,'-','') as cid,
	CASE
		WHEN TRIM(CNTRY)='DE'THEN 'Germany'
		WHEN TRIM(CNTRY) in('US','USA') THEN 'United States'
		WHEN TRIM(CNTRY)='' or CNTRY is null then 'N/A'
		ELSE TRIM(CNTRY)
	END AS cntry
	from Bronze.erp_loc_A101


select distinct cntry 
	from Bronze.erp_loc_A101
	order by CNTRY
--*************************************************
--this is transformation of erp_px_cat_g1v2

 select * from Bronze.erp_px_cat_g1v2
 where cat<>trim(CAT) or SUBCAT<>trim(SUBCAT) or MAINTENANCE<>trim(MAINTENANCE)

 --doin the data standadization & consistnacy
 select distinct 
 MAINTENANCE from Bronze.erp_px_cat_g1v2
